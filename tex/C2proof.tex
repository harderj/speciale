% Proof of Theorem 6.2 (section C.2, page 36 in YangXieWang)
% Questions to ponder:
% Should we have two 'delta's?

\begin{prop}
  $Y_i(\Prob)$ and $TQ(X_i)(\Prob)$ are i.i.d.
  \label{lem:YTQ}
\end{prop}
\begin{proof}
  Recall that $X_i = (S_i, A_i)$,
  \begin{align*}
    Y_i = \E R(X_i) + \gamma \max_{a \in \Cal{A}} Q(S_{i+1}, a)
  \end{align*}
  where $S_{i+1} \sim P(X_i)$, and
  \begin{align*}
    TQ(X_i) = \E R(X_i) + \gamma \E_{S'} Q(S', \argmax_{a \in \Cal{A}} Q(S', a))
  \end{align*}
  where $S' \sim P(X_i)$.
  It is a fundamental assumption/definition that $S'$ and $S_{i+1}$ are
  i.i.d.
\end{proof}

\begin{proof}[Proof of \cref{thm:oneStep}]
  First some introductory fixing of notation and variables.
  Fix a minimal $\delta$-covering of $\Cal{F}$
  with centers $f_1, \dots, f_{N_\delta}$.
  Define
  \[ \wt{Q} := \argmin_{f \in \Cal{F}} \norm{f - TQ}_{\nu}^2 \]
  \[ k^* := \argmin_{k \in [N_\delta]} \norm{f_k - \wh{Q}}_\infty \]
  and $ X_i := (S_i, A_i) $.
  Notice that $\wt{Q}$ differs from $\wh{Q}$ in that
  $\wt{Q}$ approximates $TQ$ w.r.t. $\norm{\cdot}^2_\nu$ while
  $\wh{Q}$ approximates $Y = (Y_1, \dots, Y_n)$ in mean squared error over
  $X = (X_1, \dots, X_n)$.
  %We define a shorthand for the average by
  %$\ol{f(X)} := 1/n \cdot \sum_{i=1}^n f(X_i)$.
  %In general we shall loosely write \emph{vectored} equations like
  %$ Y = R + \gamma \max_{a \in \Cal{A}} Q(S',a) $ 
  %(this is then meant to be equivalent to the definition of $Y$).
  We shall be loose about applying functions to vectors
  (of random variables)
  in the sense that they are applied entry-wise.
  We use $\norm{\cdot}_p$ to denote the (finite dimensional) $p$-norm
  ($p$ ommitted when $p=2$).
  When talking about $p$-norms on the random variables we always specify
  the distribution (e.g. $\norm{\cdot}_\nu$).
  When the sample (e.g. $X$) is clear from context we omit it writing
  $\norm{f} = \norm{f(X)}$.
  
  \textbf{Step 1}
  By definion (of $\wh{Q}$) for all $f \in \Cal{F}$ we have
  $\norm{\wh{Q}(X) - Y}^2 \leq \norm{f(X) - Y}^2$, leading to
  \begin{align*}
    & \norm{Y}^2 + \norm{\wh{Q}}^2 - 2 Y\cdot Q
    \leq \norm{Y}^2 + \norm{f}^2 - 2 Y\cdot f
    \\ \iff & \norm{\wh{Q}}^2 + \norm{TQ}^2 - 2 \wh{Q}\cdot TQ 
    \leq \norm{f}^2 + \norm{TQ}^2 - 2 f\cdot TQ + 2 Y\cdot \wh{Q}
    - 2 Y \cdot f - 2 \wh{Q}\cdot TQ + 2f\cdot TQ
    \\ \iff & \norm{Q - TQ}^2
    \leq \norm{f - TQ}^2 + 2(Y - TQ)\cdot(\wh{Q} - f) 
    \\ \iff & \norm{Q - TQ}^2
    \leq \norm{f - TQ}^2 + 2 \xi \cdot (\wh{Q} - f)
  \end{align*}
  Where $ \xi_i := Y_i - TQ(X_i) $ and $\xi := (\xi_1, \dots, \xi_n)$.
  By \cref{lem:YTQ} we have that $Y_i$ and $TQ(X_i)$ are i.i.d. So 
  satisfy $\E(\xi_i \mid X_i) = 0$.
  Therefore $\E(\xi_i g(X_i)) = 0$ for any function $g:\R\to \R$.
  So
  \begin{equation}
    \E \xi \cdot (\wh{Q} - f) = \E \xi \cdot (\wh{Q} - TQ)
  \end{equation}
  To bound this we insert $f_{k^*}$ by the triangle inequality
  \begin{equation}
    \abs{\E \xi \cdot (\wh{Q} - TQ) }
    \leq \abs{\E \xi \cdot (\wh{Q} - f_{k^*}) } 
    + \abs{\E \xi \cdot (f_{k^*} - TQ) }
    \label{eq:c2triangle1}
  \end{equation}
  We now bound these two terms. The first by Cauchy-Schwarz
  \begin{equation}
    \abs{\E \xi \cdot (\wh{Q} - f_{k^*})}
    \leq \E \left( \norm{\xi} \norm{\wh{Q} - f_{k^*}} \right)
    \leq \E (\norm{\xi}) \sqrt{n} \delta
    \leq 2 n V_{\max} \delta
  \end{equation}
  where we have used that $\norm{\wh{Q} - f_{k^*}}_\infty \leq \delta$ so
  \begin{equation}
    \norm{\wh{Q} - f_{k^*}}^2
    = \sum_{i=1}^n (\wh{Q}(X_i) - f_{k^*}(X_i))^2
    \leq \sum_{i=1}^n \delta^2
    = n \delta^2
  \end{equation}
  and that $\abs{Y_i}, TQ(X_i) \leq V_{\max}$ so
  \begin{equation}
    \norm{\xi}^2 = \sum_{i=1}^n (Y_i - TQ(X_i))^2 
    \leq \sum_{i=1}^n (2 V_{\max})^2
    = 4 V_{\max}^2 n
  \end{equation}
  To bound the second term in \cref{eq:c2triangle1} define
  \begin{equation}
  Z_j := \sqrt{n} \; \xi \cdot (f_j - TQ) \norm{f_j - TQ}_1^{-1}
  \end{equation}
  %TODO more steps here probably
  Then
  \begin{align*}
    \E ( \xi \cdot (f_{k^*} - TQ) )
    &= \frac{1}{\sqrt{n}} \E (\norm{f_{k^*} - TQ}_1 \abs{Z_{k^*}})
    \\ &\leq \frac{1}{\sqrt{n}}
    \E \left( \left(\norm{\wh{Q} -TQ}_1 + \norm{\wh{Q} - f_{k^*}}_1 \right)
    \abs{Z_{k^*}} \right)
    \\ &\leq \frac{1}{\sqrt{n}}
    \E \left( \left(\norm{\wh{Q} -TQ}_1 + \delta \right)
    \abs{Z_{k^*}} \right)
  \end{align*}


\end{proof}

