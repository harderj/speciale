% Proof of Theorem 6.2 (section C.2, page 36 in YangXieWang)
% Questions to ponder:
% Should we have two 'delta's?



\begin{prop}
  \label{lem:norm12ineq}
  Let $v$ be a random vector in $\R^n$ then
  \[ \E \norm{v}_1 \leq \sqrt{n} \sqrt{ \E \norm{v}_2^2 } \]
\end{prop}

\begin{proof}
  Denote $v$'s coordinates $v=(v_1, \dots, v_n)$.
  Cauchy-Schwarz applied to some vector $w$ and $(1, \dots, 1)$ yields
  \[ \norm{w}_1 \leq \sqrt{n} \norm{w}_2 \]
  Now let $w = (\E v_1, \dots, \E v_n)$.
  Then by linearity of expectation and Jensens inequality
  \[ \E \norm{v} = \norm{w} \leq \sqrt{n} \sqrt{\sum_{i=1}^n (\E v_i)^2}
  \leq \sqrt{n} \sqrt{\E \sum_{i=1}^n v_i^2} = \sqrt{n} \sqrt{\E \norm{v}_2^2} \]
\end{proof}

\begin{proof}[Proof of \cref{thm:oneStep}]
  First some introductory fixing of notation and variables.
  Fix a minimal $\delta$-covering of $\Cal{F}$
  with centers $f_1, \dots, f_{N_\delta}$.
  Define
  \[ \wt{Q} := \argmin_{f \in \Cal{F}} \norm{f - TQ}_{\nu}^2 \]
  \[ k^* := \argmin_{k \in [N_\delta]} \norm{f_k - \wh{Q}}_\infty \]
  and $ X_i := (S_i, A_i) $.
  Notice that $\wt{Q}$ differs from $\wh{Q}$ in that
  $\wt{Q}$ approximates $TQ$ w.r.t. $\norm{\cdot}^2_\nu$ while
  $\wh{Q}$ approximates $Y = (Y_1, \dots, Y_n)$ in mean squared error over
  $X = (X_1, \dots, X_n)$.
  %We define a shorthand for the average by
  %$\ol{f(X)} := 1/n \cdot \sum_{i=1}^n f(X_i)$.
  %In general we shall loosely write \emph{vectored} equations like
  %$ Y = R + \gamma \max_{a \in \Cal{A}} Q(S',a) $ 
  %(this is then meant to be equivalent to the definition of $Y$).
  We shall be loose about applying functions to vectors
  (of random variables)
  in the sense that they are applied entry-wise.
  We use $\norm{\cdot}_p$ to denote the (finite dimensional) $p$-norm
  ($p$ ommitted when $p=2$).
  When talking about $p$-norms on the random variables we always specify
  the distribution (e.g. $\norm{\cdot}_\nu$).
  When the sample (e.g. $X$) is clear from context we omit it writing
  $\norm{f} = \norm{f(X)}$.
  
  \textbf{Step 1}
  By definion (of $\wh{Q}$) for all $f \in \Cal{F}$ we have
  $\norm{\wh{Q}(X) - Y}^2 \leq \norm{f(X) - Y}^2$, leading to
  \begin{align}
    & \norm{Y}^2 + \norm{\wh{Q}}^2 - 2 Y\cdot \wh{Q}
    \leq \norm{Y}^2 + \norm{f}^2 - 2 Y\cdot f
    \\ \iff & \norm{\wh{Q}}^2 + \norm{TQ}^2 - 2 \wh{Q}\cdot TQ 
    \leq \norm{f}^2 + \norm{TQ}^2 - 2 f\cdot TQ + 2 Y\cdot \wh{Q}
    - 2 Y \cdot f - 2 \wh{Q}\cdot TQ + 2f\cdot TQ
    \\ \iff & \norm{\wh{Q} - TQ}^2
    \leq \norm{f - TQ}^2 + 2(Y - TQ)\cdot(\wh{Q} - f) 
    \\ \iff & \norm{\wh{Q} - TQ}^2
    \leq \norm{f - TQ}^2 + 2 \xi \cdot (\wh{Q} - f)
    \label{eq:c2first}
  \end{align}
  Where $ \xi_i := Y_i - TQ(X_i) $ and $\xi := (\xi_1, \dots, \xi_n)$.
  Now we proof a minor lemma
  \begin{prop}
    $\E(\xi_i g(X_i)) = 0$ for any function $g:\R\to \R$.
    \label{lem:YTQ}
  \end{prop}
  \begin{proof}
    Recall that $X_i = (S_i, A_i)$,
    \begin{align*}
      Y_i = R_i + \gamma \max_{a \in \Cal{A}} Q(S_{i+1}, a)
    \end{align*}
    where $S_{i+1} \sim P(X_i)$, $R_i \sim R(X_i)$ and
    \begin{align*}
      TQ(X_i) = \E_{X_i} R'_i
      + \gamma \E_{X_i} Q(S', \argmax_{a \in \Cal{A}} Q(S', a))
    \end{align*}
    where $S' \sim P(X_i)$, $R'_i \sim R(X_i)$.
    Since $S'$ and $S_{i+1}$ are i.i.d.
    \begin{align*}
      \E_{X_i} \xi_i & = \E_{X_i} \left( Y_i - TQ(X_i) \right)
      \\ & = \E_{X_i} R_i - \E_{X_i} R'_i
      + \gamma \left( \E_{X_i} \left( \max_{a \in\Cal{A}} Q(S_{i+1}, a) \right)
      - \E_{X_i} \argmax_{a \in \Cal{A}} \left(  Q(S', a) \right) \right)
      \\ & = 0 
    \end{align*}
    Therefore $\E(\xi_i g(X_i)) = 0$.
  \end{proof}
  By this lemma we can deduce
  \begin{equation}
    \E \left( \xi \cdot (\wh{Q} - f) \right)
    = \E \left( \xi \cdot (\wh{Q} - TQ) \right)
  \end{equation}
  To bound this we insert $f_{k^*}$ by the triangle inequality
  \begin{equation}
    \abs{\E \left( \xi \cdot (\wh{Q} - TQ) \right) }
    \leq \abs{\E \left( \xi \cdot (\wh{Q} - f_{k^*}) \right) } 
    + \abs{\E \left( \xi \cdot (f_{k^*} - TQ) \right) }
    \label{eq:c2triangle1}
  \end{equation}
  We now bound these two terms. The first by Cauchy-Schwarz
  \begin{equation}
    \abs{\E \xi \cdot (\wh{Q} - f_{k^*})}
    \leq \E \left( \norm{\xi} \norm{\wh{Q} - f_{k^*}} \right)
    \leq \E (\norm{\xi}) \sqrt{n} \delta
    \leq 2 n V_{\max} \delta
    \label{eq:c2firstcs}
  \end{equation}
  where we have used that $\norm{\wh{Q} - f_{k^*}}_\infty \leq \delta$ so
  \begin{equation}
    \norm{\wh{Q} - f_{k^*}}^2
    = \sum_{i=1}^n (\wh{Q}(X_i) - f_{k^*}(X_i))^2
    \leq \sum_{i=1}^n \delta^2
    = n \delta^2
  \end{equation}
  and that $\abs{Y_i}, TQ(X_i) \leq V_{\max}$ so
  \begin{equation}
    \norm{\xi}^2 = \sum_{i=1}^n (Y_i - TQ(X_i))^2 
    \leq \sum_{i=1}^n (2 V_{\max})^2
    = 4 V_{\max}^2 n
  \end{equation}
  To bound the second term in \cref{eq:c2triangle1} define
  \begin{equation}
  Z_j := \xi \cdot (f_j - TQ) \norm{f_j - TQ}^{-1}
  \end{equation}
  %TODO more steps here probably
  Then
  \begin{align}
    \E \left( \xi \cdot (f_{k^*} - TQ) \right)
    &= \E \left( \norm{f_{k^*} - TQ} \abs{Z_{k^*}} \right)
    \label{eq:long1_1}
    \\ &\leq 
    \E \left( \left(\norm{\wh{Q} - TQ} + \norm{\wh{Q} - f_{k^*}} \right)
    \abs{Z_{k^*}} \right) 
    \label{eq:long1_2}
    \\ &\leq 
    \E \left( \left(\norm{\wh{Q} - TQ} + n \delta \right)
    \abs{Z_{k^*}} \right) 
    \label{eq:long1_3}
    \\ &\leq 
    \left( \E \left(\norm{\wh{Q} - TQ} + n \delta \right)^2 \right)^{1/2}
    \left( \E Z_{k^*}^2 \right)^{1/2} 
    \label{eq:long1_4}
    \\ &\leq 
    \E \left(\norm{\wh{Q} - TQ} + n \delta \right) 
    \left( \E Z_{k^*}^2 \right)^{1/2} 
    \label{eq:long1_5}
    \\ &\leq 
    \left(\sqrt{ \E \norm{\wh{Q} -TQ}_2^2 } + n \delta \right) 
    \left( \E Z_{k^*}^2 \right)^{1/2} 
    \label{eq:long1_6}
    \\ &\leq \left(\sqrt{\E \norm{\wh{Q} -TQ}_2^2} + n \delta \right)
    2 V_{\max} 
    \label{eq:long1_8}
  \end{align}
  Where \cref{eq:long1_1} to \cref{eq:long1_2} is by the triangle inequality,
  \cref{eq:long1_5} to \cref{eq:long1_6} is \cref{lem:norm12ineq}
  and \cref{eq:long1_6} to \cref{eq:long1_8} is due to the following
  \begin{prop}
    \[ |Z_j| \leq 2 V_{\max} \]
  \end{prop}
  \begin{proof} For any $i \in [n]$
    \[ |\xi_i| = |Y_i - \wh{Q}(X_i)| \leq |Y_i| + |\wh{Q}(X_i)|
    \leq 2 V_{\max} \]
    Thus
    \begin{align*}
      \xi \cdot (f_j - TQ)
      & \leq \norm{\xi} \cdot \norm{f_j - TQ} \cdot \norm{f_j - TQ}^{-1}
      \\ & \leq 2 V_{\max} 
    \end{align*}
  \end{proof}
  Combining \cref{eq:c2first}, \cref{eq:c2triangle1},
  \cref{eq:c2firstcs} and \cref{eq:long1_8}
  \begin{align}
    \E \norm{\wh{Q} - TQ}^2 & \leq \E \norm{f - TQ}^2 + 4 n V_{\max} \delta
    + \left( \sqrt{\E \norm{\wh{Q} - TQ}^2} + \sqrt{n} \delta \right)
    2 V_{\max} 
    \\ & = 2 \sqrt{\E \norm{\wh{Q} - TQ}^2} V_{\max} 
    + 6 n \delta V_{\max} + \E \norm{f - TQ}^2
    \label{eq:c2step1comb}
  \end{align}
  \begin{lem} Let $a,b>0, \kappa \in (0,1]$ then
    \[ a^2 \leq 2ab + c \implies a^2 \leq (1 + \kappa)^2 b^2 / \kappa
    + (1 + \kappa) c \]
    \label{lem:abc}
  \end{lem}
  \begin{proof} $0 \leq (x - y) = x^2 + y^2 - 2xy \implies 2xy \leq x^2 + y^2$
    for any $x, y \in \R$ so
    \begin{align*}
      2ab & = 2 \sqrt{\frac{\kappa}{1+\kappa}} a \sqrt{\frac{1+\kappa}{\kappa}} b
      \\ & \leq \frac{\kappa}{1+\kappa} a^2 + \frac{1 + \kappa}{\kappa} b^2
    \end{align*}
  \end{proof}
  By \cref{lem:abc} applied to \cref{eq:c2step1comb}
  \begin{align}
    \frac{1}{n} \E \norm{\wh{Q} - TQ}^2
    & \leq \frac{(1+\kappa)^2}{\kappa} \frac{1}{n} V_{\max}^2
    + (1 + \kappa) \left( 6 \delta V_{\max}
    + \frac{1}{n} \E \norm{f - TQ}^2 \right)
    \label{eq:c2step1final0}
    \\ & \leq \frac{(1+\kappa)^2}{\kappa} \frac{1}{n} V_{\max}^2
    + (1 + \kappa) \left( 6 \delta V_{\max}
    + \inf_{f \in \Cal{F}} \frac{1}{n} \E \norm{f - TQ}^2 \right)
    \label{eq:c2step1final}
  \end{align}
  Here we can take infimum since
  \cref{eq:c2step1final0} holds for all $f \in \Cal{F}$.

  \textbf{Step 2} Here we link up $\norm{\wh{Q} - TQ}_{\sigma}^2$ 
  with $\E \frac{1}{n} \norm{\wh{Q} -TQ}^2$.
  \begin{align}
    \abs{ \left( \wh{Q}(x) - TQ(x) \right)^2
    - \left( f_{k^*}(x) - TQ(x) \right)^2 }
    &= \abs{ \wh{Q}(x) - f_{k^*}(x) } \cdot
    \abs{ \wh{Q}(x) + f_{k^*}(x) - 2 TQ(x) }
    \\ & \leq 4 V_{\max} \delta
  \end{align}
  Using this twice we can say
  \begin{align}
    & (\wh{Q}(\wh{X}_i) - TQ(\wh{X}_i)^2 
    \\ \leq {} & (\wh{Q}(\wt{X}_i) - TQ(\wt{X}_i))^2
    - (f_{k^*}(\wt{X}_i) - TQ(\wt{X}_i))^2
    + (f_{k^*}(\wt{X}_i) - TQ(\wt{X}_i))^2 
    \\ \leq {} & (f_{k^*}(\wt{X}_i) - TQ(\wt{X}_i))^2 
    + (\wh{Q}(X_i) - TQ(X_i))^2
    - (\wh{Q}(X_i) - TQ(X_i))^2
    \notag \\ & + (f_{k^*}(X_i) - TQ(X_i))^2
    - (f_{k^*}(X_i) - TQ(X_i))^2 + 4 V_{\max} \delta
    \\ \leq {} & (\wh{Q}(X_i) - TQ(X_i))^2
    + (f_{k^*}(\wt{X}_i) - TQ(\wt{X}_i))^2
    - (f_{k^*}(X_i) - TQ(X_i))^2
    + 8 V_{\max} \delta
    \label{eq:c2step2long1}
  \end{align}
  Thus we get
  \begin{align}
    & \norm{\wh{Q} - TQ}_\sigma^2
    \\ = {} & \E \frac{1}{n} \sum_{i=1}^n (\wh{Q}(\wt{X}_i) - TQ(\wt{X}_i))^2
    \\ \leq {} & \E \frac{1}{n} \sum_{i=1}^n \left( (\wh{Q}(X_i) - TQ(X_i))^2 
      + (f_{k^*}(\wt{X}_i) - TQ(\wt{X}_i))^2
    - (f_{k^*}(X_i) - TQ(X_i))^2 \right)
    + 8 V_{\max} \delta 
    \\ = {} & \frac{1}{n} \norm{\wh{Q} - TQ}^2
    + \frac{1}{n} \sum_{i=1}^n h_{k^*}(X_i, \wt{X}_i)
    + 8 V_{\max}
  \end{align}
  Where we define
  \begin{equation}
    h_j(x, y) \defeq \left( f_j(y) - TQ(y) \right)^2
    - \left( f_j(x) - TQ(x) \right)^2
    \label{eq:c2step2hdef}
  \end{equation}
  
\end{proof}



